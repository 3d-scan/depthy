window.Modernizr=function(a,b,c){function d(a){s.cssText=a}function e(a,b){return typeof a===b}function f(a,b){return!!~(""+a).indexOf(b)}function g(a,b){for(var d in a){var e=a[d];if(!f(e,"-")&&s[e]!==c)return"pfx"==b?e:!0}return!1}function h(a,b,d){for(var f in a){var g=b[a[f]];if(g!==c)return d===!1?a[f]:e(g,"function")?g.bind(d||b):g}return!1}function i(a,b,c){var d=a.charAt(0).toUpperCase()+a.slice(1),f=(a+" "+v.join(d+" ")+d).split(" ");return e(b,"string")||e(b,"undefined")?g(f,b):(f=(a+" "+w.join(d+" ")+d).split(" "),h(f,b,c))}var j,k,l,m="2.7.2",n={},o=!0,p=b.documentElement,q="modernizr",r=b.createElement(q),s=r.style,t=({}.toString," -webkit- -moz- -o- -ms- ".split(" ")),u="Webkit Moz O ms",v=u.split(" "),w=u.toLowerCase().split(" "),x={},y=[],z=y.slice,A=function(a,c,d,e){var f,g,h,i,j=b.createElement("div"),k=b.body,l=k||b.createElement("body");if(parseInt(d,10))for(;d--;)h=b.createElement("div"),h.id=e?e[d]:q+(d+1),j.appendChild(h);return f=["&#173;",'<style id="s',q,'">',a,"</style>"].join(""),j.id=q,(k?j:l).innerHTML+=f,l.appendChild(j),k||(l.style.background="",l.style.overflow="hidden",i=p.style.overflow,p.style.overflow="hidden",p.appendChild(l)),g=c(j,a),k?j.parentNode.removeChild(j):(l.parentNode.removeChild(l),p.style.overflow=i),!!g},B={}.hasOwnProperty;l=e(B,"undefined")||e(B.call,"undefined")?function(a,b){return b in a&&e(a.constructor.prototype[b],"undefined")}:function(a,b){return B.call(a,b)},Function.prototype.bind||(Function.prototype.bind=function(a){var b=this;if("function"!=typeof b)throw new TypeError;var c=z.call(arguments,1),d=function(){if(this instanceof d){var e=function(){};e.prototype=b.prototype;var f=new e,g=b.apply(f,c.concat(z.call(arguments)));return Object(g)===g?g:f}return b.apply(a,c.concat(z.call(arguments)))};return d}),x.canvas=function(){var a=b.createElement("canvas");return!!a.getContext&&!!a.getContext("2d")},x.webgl=function(){return!!a.WebGLRenderingContext},x.touch=function(){var c;return"ontouchstart"in a||a.DocumentTouch&&b instanceof DocumentTouch?c=!0:A(["@media (",t.join("touch-enabled),("),q,")","{#modernizr{top:9px;position:absolute}}"].join(""),function(a){c=9===a.offsetTop}),c};for(var C in x)l(x,C)&&(k=C.toLowerCase(),n[k]=x[C](),y.push((n[k]?"":"no-")+k));return n.addTest=function(a,b){if("object"==typeof a)for(var d in a)l(a,d)&&n.addTest(d,a[d]);else{if(a=a.toLowerCase(),n[a]!==c)return n;b="function"==typeof b?b():b,"undefined"!=typeof o&&o&&(p.className+=" "+(b?"":"no-")+a),n[a]=b}return n},d(""),r=j=null,n._version=m,n._prefixes=t,n._domPrefixes=w,n._cssomPrefixes=v,n.testProp=function(a){return g([a])},n.testAllProps=i,n.testStyles=A,n.prefixed=function(a,b,c){return b?i(a,b,c):i(a,"pfx")},p.className=p.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(o?" js "+y.join(" "):""),n}(this,this.document),Modernizr.addTest("devicemotion","DeviceMotionEvent"in window),Modernizr.addTest("deviceorientation","DeviceOrientationEvent"in window),Modernizr.addTest("performance",!!Modernizr.prefixed("performance",window)),function(){Modernizr.addTest("ios",/iPad|iPhone|iPod/.test(window.navigator.userAgent)),Modernizr.addTest("android",/Android/i.test(window.navigator.userAgent)),Modernizr.addTest("winphone",/IEMobile/i.test(window.navigator.userAgent)),Modernizr.addTest("mobile",/iPad|iPhone|iPod|Android|IEMobile/.test(window.navigator.userAgent)),Modernizr.addTest("ff",/Firefox/.test(window.navigator.userAgent)),Modernizr.addTest("ie",/; MSIE/.test(window.navigator.userAgent)),Modernizr.addTest("chrome",/\bChrome\b/.test(window.navigator.userAgent)),Modernizr.addTest("safari",/\bSafari\b/.test(window.navigator.userAgent)&&!/\bChrome\b/.test(window.navigator.userAgent))}(),angular.module("depthyApp",["ga"]),angular.module("depthyApp").controller("MainCtrl",["$scope","$timeout","ga",function(a,b,c){function d(b){a.$watch(b+"Source",function(c){if(a[b+"Size"]=null,c){var d=new Image;d.onload=function(){a[b+"Size"]={width:d.width,height:d.height},d.onload=null,d.src="",a.$apply()},d.src=c}})}var e=this;a.compoundSource="samples/flowers-compound.jpg",a.depthSource="samples/flowers-depth.jpg",a.imageSource="samples/flowers-image.jpg",a.Modernizr=window.Modernizr,a.processing=!1,a.loadSample=function(b){a.compoundSource="samples/"+b+"-compound.jpg",a.depthSource="samples/"+b+"-depth.jpg",a.imageSource="samples/"+b+"-image.jpg",a.metadata={},a.compoundError=null,c("send","event","sample",b)},this.handleCompoundFile=function(d){var f=function(b){a.imageSource=!1,a.depthSource=!1,a.metadata={},a.compoundError=b,c("send","event","image","error",b)};return"image/jpeg"!==d.type?void f("Only JPEGs are supported!"):(a.processing=!0,void b(function(){var b=new FileReader;b.onload=function(b){a.compoundError="";try{var c=e.parseCompoundImage(b.target.result);a.imageSource=c.imageUri,a.depthSource=c.depthUri,delete c.imageData,delete c.depthData,delete c.imageUri,delete c.depthUri,a.metaData=c}catch(b){f(b)}a.processing=!1,a.$apply()},b.readAsBinaryString(d);var c=new FileReader;c.onload=function(b){a.compoundSource=b.target.result,a.$apply()},c.readAsDataURL(d)},100))},this.parseCompoundImage=function(a){var b=(a.match(/xmpNote:HasExtendedXMP="(.+?)"/i)||[])[1];b&&(a=a.replace(new RegExp("[\\s\\S]{4}http:\\/\\/ns\\.adobe\\.com\\/xmp\\/extension\\/[\\s\\S]"+b+"[\\s\\S]{8}","g"),""));var d=a.match(/<x:xmpmeta [\s\S]+?<\/x:xmpmeta>/g),e={};if(!d)throw"No XMP metadata found!";if(d=d.join("\n",d),e.imageMime=(d.match(/GImage:Mime="(.+?)"/i)||[])[1],e.imageData=(d.match(/GImage:Data="(.+?)"/i)||[])[1],e.depthMime=(d.match(/GDepth:Mime="(.+?)"/i)||[])[1],e.depthData=(d.match(/GDepth:Data="(.+?)"/i)||[])[1],e.imageMime&&e.imageData&&(e.imageUri="data:"+e.imageMime+";base64,"+e.imageData),e.depthMime&&e.depthData&&(e.depthUri="data:"+e.depthMime+";base64,"+e.depthData),!e.depthUri)throw"No depth map found!";if(!e.imageUri)throw"No original image found!";return e.focalDistance=(d.match(/GFocus:FocalDistance="(.+?)"/i)||[])[1],c("send","event","image","parsed"),e},a.$watch("compoundFiles",function(a){a&&a.length&&e.handleCompoundFile(a[0])}),d("compound"),d("image"),d("depth")}]),angular.module("depthyApp").directive("fileselect",["$parse",function(a){return{restrict:"A",scope:!0,link:function(b,c,d){function e(c){b.$broadcast("fileselect",c),console.log(d.fileselect),d.fileselect&&a(d.fileselect).assign(b,c)}var f=document.createElement("input");f.type="file",f.style.visibility="hidden",f.style.position="absolute",f.style.left="-9000px",c.append(f);var g=function(a){a.stopPropagation(),a.preventDefault()},h=function(a){a.stopPropagation(),a.preventDefault(),console.log(a);var c=a.originalEvent.dataTransfer;console.log(c);var d=c.files;console.log(d),e(d),b.$apply()};b.selectFile=function(a){f.click(),a&&a.preventDefault()},c.on("dragenter",g),c.on("dragover",g),c.on("drop",h),f.addEventListener("change",function(){e(this.files),b.$apply()},!1)}}}]),angular.module("depthyApp").directive("pixi",["$parse","$window",function(a){return{template:"<canvas></canvas>",restrict:"A",scope:!0,link:function(b,c,d){function e(){var a;i&&(a=i(h,j)),requestAnimFrame(e),a!==!1&&j.render(h)}var f=b.$parent,g=a(d.pixi),h=g(f),i=f.$eval(d.pixiAnimate);h||(h=new PIXI.Stage(f.$eval(d.pixiBackground||"0")),g.assign(f,h));var j,k=f.$eval(d.pixiAntialias||"false"),l=f.$eval(d.pixiTransparent||"false"),m=f.$eval(d.pixiRenderer||"auto");switch(m){case"canvas":j=new PIXI.CanvasRenderer(c.width(),c.height(),c[0],l);break;case"webgl":try{j=new PIXI.WebGLRenderer(c.width(),c.height(),c[0],l,k)}catch(n){return void(Modernizr.webgl=!1)}break;default:j=PIXI.autoDetectRenderer(c.width(),c.height(),c[0],k,l)}requestAnimFrame(e)}}}]),angular.module("depthyApp").controller("ViewerCtrl",["$scope","$element","$window","$timeout",function(a,b,c,d){function e(e,f){var g,h,i,j;a.$watch("[viewerVisible, compoundSize, imageSize, depthSize, sizeDirty]",function(){if(a.viewerVisible&&a.imageSize&&a.depthSize&&a.compoundSize){var d=a.compoundSize,e=d.width/d.height,f={width:d.width,height:d.height};f.height>.8*$(c).height()&&(f.height=Math.round(.8*$(c).height()),f.width=f.height*e),f.width>.8*$(c).width()&&(f.width=Math.round(.8*$(c).width()),f.height=f.width/e),window.devicePixelRatio>=2&&(f.width*=2,f.height*=2,b.find("canvas").css("width",f.width/2+"px").css("height",f.height/2+"px")),a.stageSize=f}},!0),a.$watch("[viewerVisible, compoundSource, imageSource, depthSource, viewCompound, stageSize, compoundSize, imageSize, depthSize, scaleUp]",function(){if(a.imageReady=a.viewerVisible&&a.imageSource&&a.depthSource&&a.imageSize&&a.depthSize&&a.compoundSize,i&&(e.removeChild(i),i=null,a.update=1),a.imageReady){var b=a.compoundSize,c=a.stageSize,k=c.width/b.width;f.resize(c.width,c.height),g=PIXI.Texture.fromImage(a.viewCompound?a.compoundSource:a.imageSource),h=PIXI.Texture.fromImage(a.depthSource),i=new PIXI.Sprite(g);var l=(Modernizr.mobile?.015:.015)*(a.scaleUp?2:1);a.depthFilter=j=new PIXI.DepthmapFilter(h),j.scale={x:(c.width>c.height?1:c.height/c.width)*l,y:(c.width<c.height?1:c.width/c.height)*l},i.filters=[j],i.scale=new PIXI.Point(k,k),e.addChild(i),a.update=1,d(function(){a.update=1},100)}},!0),b.on("mousemove touchmove",function(c){if(!a.animate){var d=b.offset(),e=b.width(),f=b.height(),g=.8*a.stageSize.height,h=c.originalEvent.touches?c.originalEvent.touches[0]:c,i=(h.pageX-d.left)/e,k=(h.pageY-d.top)/f;i=Math.max(-1,Math.min(1,(2*i-1)*e/g)),k=Math.max(-1,Math.min(1,(2*k-1)*f/g)),j&&(a.offset={x:-i,y:-k},a.update=1)}});var k={};c.addEventListener("deviceorientation",function(b){if(null!==b.beta&&null!==b.gamma){if(k&&!a.animate){var c=window.innerHeight>window.innerWidth,d=.2*(b.beta-k.beta),e=.2*(b.gamma-k.gamma),f=c?-e:-d,g=c?-d:-e;j&&(f&&g&&(a.offset={x:Math.max(-1,Math.min(1,a.offset.x+f)),y:Math.max(-1,Math.min(1,a.offset.y+g))}),a.update=1)}k={alpha:b.alpha,beta:b.beta,gamma:b.gamma}}}),c.addEventListener("resize",function(){a.sizeDirty++,a.$apply()})}a.stage=null,a.viewCompound=!0,a.animate=!1,a.scaleUp=!1,a.sizeDirty=0,a.update=1,a.viewerVisible=!0,a.depthFilter=null,a.offset={x:0,y:0},a.easedOffset={x:0,y:0},a.easeFactor=Modernizr.mobile?.2:.9;var f=!1;a.pixiAnimate=function(b,c){if(!f)return e(b,c),f=!0,void a.$apply();if((a.offset.x!=a.easedOffset.x||a.offset.y!=a.easedOffset.y)&&(a.easedOffset.x=a.easedOffset.x*a.easeFactor+a.offset.x*(1-a.easeFactor),a.easedOffset.y=a.easedOffset.y*a.easeFactor+a.offset.y*(1-a.easeFactor),Math.abs(a.easedOffset.x-a.offset.x)<1e-4&&Math.abs(a.easedOffset.y-a.offset.y)<1e-4&&(a.easedOffset=a.offset),a.depthFilter.offset={x:a.easedOffset.x,y:a.easedOffset.y},a.update=1),a.animate){var d=Modernizr.performance?window.performance.now():new Date;a.depthFilter.offset={x:Math.sin(d*Math.PI/1e3),y:Math.cos(d*Math.PI/1e3)},a.update=1}return a.update?void a.update--:!1}}]),PIXI.DepthmapFilter=function(a){PIXI.AbstractFilter.call(this),this.passes=[this],this.uniforms={displacementMap:{type:"sampler2D",value:a},scale:{type:"2f",value:{x:.015,y:.015}},offset:{type:"2f",value:{x:0,y:0}},mapDimensions:{type:"2f",value:{x:1,y:5112}},dimensions:{type:"4fv",value:[0,0,0,0]}},a.baseTexture.hasLoaded?(this.uniforms.mapDimensions.value.x=a.width,this.uniforms.mapDimensions.value.y=a.height):(this.boundLoadedFunction=this.onTextureLoaded.bind(this),a.baseTexture.on("loaded",this.boundLoadedFunction)),this.fragmentSrc=["precision mediump float;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform sampler2D displacementMap;","uniform sampler2D uSampler;","uniform vec2 scale;","uniform vec2 offset;","uniform vec4 dimensions;","uniform vec2 mapDimensions;","void main(void) {","   vec2 mapCords = vTextureCoord;","   mapCords.y *= -1.0;","   mapCords.y += 1.0;","   float map = texture2D(displacementMap, mapCords).r;","   map = map * -1.0 + 0.5;","   vec2 disCords = vTextureCoord;","   disCords += offset * vec2(1.0, -1.0) * map * scale;","   gl_FragColor = texture2D(uSampler, disCords) * vColor;","}"]},PIXI.DepthmapFilter.prototype=Object.create(PIXI.AbstractFilter.prototype),PIXI.DepthmapFilter.prototype.constructor=PIXI.DepthmapFilter,PIXI.DepthmapFilter.prototype.onTextureLoaded=function(){this.uniforms.mapDimensions.value.x=this.uniforms.displacementMap.value.width,this.uniforms.mapDimensions.value.y=this.uniforms.displacementMap.value.height,this.uniforms.displacementMap.value.baseTexture.off("loaded",this.boundLoadedFunction)},Object.defineProperty(PIXI.DepthmapFilter.prototype,"map",{get:function(){return this.uniforms.displacementMap.value},set:function(a){this.uniforms.displacementMap.value=a}}),Object.defineProperty(PIXI.DepthmapFilter.prototype,"scale",{get:function(){return this.uniforms.scale.value},set:function(a){this.uniforms.scale.value=a}}),Object.defineProperty(PIXI.DepthmapFilter.prototype,"offset",{get:function(){return this.uniforms.offset.value},set:function(a){this.uniforms.offset.value=a}});